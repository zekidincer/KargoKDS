<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Depo YÃ¶netimi | ZEKA KDS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* MEVCUT TASARIMINIZ KORUNDU */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #ecf0f1; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .menu-item { padding: 15px; color: #bdc3c7; text-decoration: none; display: block; margin: 5px 0; border-radius: 5px; transition:0.3s; display: flex; align-items: center; }
        .menu-item:hover, .menu-item.active { background: #34495e; color: white; }
        .menu-item i { margin-right: 10px; width: 20px; text-align: center; }
        .content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-action { padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; }
        .btn-sim { background: #e67e22; } .btn-reset { background: #34495e; }
        .stat-badge { background: #2c3e50; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; margin-left: 10px; }
        .stat-badge.red { background: #e74c3c; }

        .main-row { display: flex; gap: 20px; height: 450px; }
        .list-panel { flex: 1; background: white; border-radius: 10px; padding: 20px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .map-panel { flex: 2; background: white; border-radius: 10px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; }
        #map { height: 100%; width: 100%; border-radius: 5px; }

        .bottom-row { display: flex; gap: 20px; height: 300px; }
        .chart-card { flex: 1; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .canvas-container { flex: 1; position: relative; min-height: 200px; }

        /* LÄ°STE GÃ–RÃœNÃœMÃœ */
        .depo-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
        .progress-bg { width: 80px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
    </style>
</head>
<body>
    <div class="sidebar">
    <h2 style="font-size:20px; border-bottom:1px solid #34495e; padding-bottom:15px; margin-top:0;">ðŸ“¦ ZEKA KDS</h2>
    
    <a href="dashboard.html" class="menu-item"><i class="fas fa-home"></i> Genel BakÄ±ÅŸ</a>
    <a href="simulasyon.html" class="menu-item"><i class="fas fa-coins"></i> Finansal SimÃ¼lasyon</a>
    <a href="filo.html" class="menu-item"><i class="fas fa-truck"></i> AraÃ§ Filosu</a>
    <a href="depolar.html" class="menu-item"><i class="fas fa-warehouse"></i> Depolar & Harita</a>
    
    <a href="personel.html" class="menu-item"><i class="fas fa-users"></i> Personel Analizi</a>
    
    <a href="login.html" class="menu-item" style="margin-top:auto;"><i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ</a>
</div>

    <div class="content">
        <div class="header-bar">
            <div><h2 style="margin:0; color:#2c3e50;">Depo Kapasite & Lokasyon</h2><span style="color:#7f8c8d; font-size:12px;">Ä°zmir BÃ¶lge MÃ¼dÃ¼rlÃ¼ÄŸÃ¼</span></div>
            <div style="display:flex; align-items:center;">
                <button class="btn-action btn-sim" onclick="siparisYagdir()"><i class="fas fa-cloud-download-alt"></i> SipariÅŸ YaÄŸdÄ±r</button>
                <button class="btn-action btn-reset" onclick="sifirla()" style="margin-left:10px;"><i class="fas fa-undo"></i> SÄ±fÄ±rla</button>
                <div class="stat-badge"><i class="fas fa-warehouse"></i> <span id="depoCount">0</span></div>
                <div class="stat-badge red"><i class="fas fa-exclamation-triangle"></i> <span id="kritikCount">0</span></div>
            </div>
        </div>

        <div class="main-row">
            <div class="list-panel" id="depoListesi"><p style="text-align:center; color:#999;">YÃ¼kleniyor...</p></div>
            <div class="map-panel"><div id="map"></div></div>
        </div>

        <div class="bottom-row">
            <div class="chart-card"><h4 style="margin:0 0 10px 0; text-align:center;">Kapasite KullanÄ±mÄ± (mÂ³)</h4><div class="canvas-container"><canvas id="barChart"></canvas></div></div>
            <div class="chart-card"><h4 style="margin:0 0 10px 0; text-align:center;">GerÃ§ek AraÃ§ DaÄŸÄ±lÄ±mÄ± (VeritabanÄ±)</h4><div class="canvas-container"><canvas id="horizChart"></canvas></div></div>
        </div>
    </div>

    <script>
        let map;
        const ilceCoords = {
            'AliaÄŸa': [38.7993, 26.9728], 'BalÃ§ova': [38.3892, 27.0461], 'BayÄ±ndÄ±r': [38.2167, 27.6472], 'BayraklÄ±': [38.4619, 27.1733],
            'Bergama': [39.1228, 27.1800], 'BeydaÄŸ': [38.0867, 28.2083], 'Bornova': [38.4675, 27.2222], 'Buca': [38.3825, 27.1711],
            'Ã‡eÅŸme': [38.3233, 26.3042], 'Ã‡iÄŸli': [38.4875, 27.0722], 'Dikili': [39.0717, 26.8900], 'FoÃ§a': [38.6694, 26.7556],
            'Gaziemir': [38.3211, 27.1278], 'GÃ¼zelbahÃ§e': [38.3736, 26.8933], 'KarabaÄŸlar': [38.3761, 27.1350], 'Karaburun': [38.6367, 26.5133],
            'KarÅŸÄ±yaka': [38.4572, 27.1172], 'KemalpaÅŸa': [38.4250, 27.4194], 'KÄ±nÄ±k': [39.0833, 27.3833], 'Kiraz': [38.2306, 28.2056],
            'Konak': [38.4189, 27.1286], 'Menderes': [38.2500, 27.1333], 'Menemen': [38.6000, 27.0722], 'NarlÄ±dere': [38.3972, 27.0139],
            'Ã–demiÅŸ': [38.2289, 27.9733], 'Seferihisar': [38.1983, 26.8389], 'SelÃ§uk': [37.9483, 27.3683], 'Tire': [38.0878, 27.7317],
            'TorbalÄ±': [38.1528, 27.3639], 'Urla': [38.3225, 26.7633]
        };

        function initMap() {
            map = L.map('map').setView([38.4192, 27.1287], 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        }

        // --- ANA VERÄ° YÃœKLEME FONKSÄ°YONU ---
        function veriYukle() {
            // Server'dan depo verilerini Ã§ek
            fetch('/api/depolar')
            .then(res => res.json())
            .then(data => {
                
                // API'den gelen veriyi frontend yapÄ±sÄ±na Ã§eviriyoruz
                // { Ilce: 'Konak', Kullanilan: 7500... } -> { name: 'Konak', load: 7500... }
                const displayData = data.map(d => ({
                    name: d.Ilce,
                    load: d.Kullanilan,
                    capacity: d.Kapasite,
                    Oran: d.Oran,
                    Renk: d.Renk,
                    Durum: d.Durum,
                    AracSayisi: d.AracSayisi
                }));

                // Ä°statistikleri GÃ¼ncelle
                document.getElementById('depoCount').innerText = displayData.length;
                document.getElementById('kritikCount').innerText = displayData.filter(d => d.Oran > 100).length;

                // Ekrana Bas
                renderList(displayData);
                renderMap(displayData);
                renderCharts(displayData);
            })
            .catch(err => {
                console.error("Veri yÃ¼kleme hatasÄ±:", err);
                document.getElementById('depoListesi').innerHTML = "<p style='text-align:center;color:red;'>VeritabanÄ± baÄŸlantÄ± hatasÄ±!</p>";
            });
        }

        function renderList(data) {
            const listDiv = document.getElementById('depoListesi');
            listDiv.innerHTML = '';
            
            if(data.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; padding:20px;">VeritabanÄ±nda depo bulunamadÄ±.</p>';
                return;
            }

            data.forEach(d => {
                let barW = Math.min(d.Oran, 100);
                listDiv.innerHTML += `
                    <div class="depo-item">
                        <div style="font-weight:bold; width:90px;">${d.name}</div>
                        <div style="display:flex; align-items:center;">
                            <div class="progress-bg"><div class="progress-fill" style="width:${barW}%; background:${d.Renk};"></div></div>
                            <span style="font-size:11px; font-weight:bold; color:${d.Renk};">%${d.Oran}</span>
                        </div>
                        <div style="font-size:11px; color:#666;">YÃ¼k: <b>${d.load}</b> / ${d.capacity}</div>
                        <div style="font-size:10px; font-weight:bold; color:${d.Renk}; text-transform:uppercase; width:80px; text-align:right;">${d.Durum}</div>
                    </div>`;
            });
        }

        function renderMap(data) {
            map.eachLayer(l => { if(l instanceof L.CircleMarker) map.removeLayer(l); });
            data.forEach(d => {
                if(ilceCoords[d.name]) {
                    L.circleMarker(ilceCoords[d.name], { radius: d.Oran>100?10:6, fillColor: d.Renk, color: '#fff', weight:2, fillOpacity:0.8 })
                    .addTo(map).bindPopup(`<b>${d.name}</b><br>Durum: ${d.Durum}<br>Doluluk: %${d.Oran}<br>AraÃ§: ${d.AracSayisi}`);
                }
            });
        }

        let chart1, chart2;
        function renderCharts(data) {
            if(chart1) chart1.destroy(); 
            // chart2 drawRealVehicleChart iÃ§inde yÃ¶netiliyor

            const labels = data.map(d => d.name);
            const colors = data.map(d => d.Renk);

            // 1. Kapasite GrafiÄŸi (VeritabanÄ±ndan Gelen)
            chart1 = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Mevcut YÃ¼k', data: data.map(d=>d.load), backgroundColor: colors },
                        { label: 'Kapasite', data: data.map(d=>d.capacity), backgroundColor: '#ecf0f1', hidden:true }
                    ]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
            });

            // 2. AraÃ§ GrafiÄŸi (AyrÄ± API'den)
            drawRealVehicleChart();
        }

        // --- ARAÃ‡ GRAFÄ°ÄžÄ°NÄ° Ã‡Ä°ZEN FONKSÄ°YON (SENÄ°N Ä°STEDÄ°ÄžÄ°N KISIM) ---
        function drawRealVehicleChart() {
            fetch('/api/vehicles') 
            .then(response => {
                if(!response.ok) throw new Error("API HatasÄ±");
                return response.json();
            })
            .then(vehicles => {
                const ilceSayilari = {};
                vehicles.forEach(vehicle => {
                    // VeritabanÄ±ndan gelen 'ilce' sÃ¼tununu kullan
                    const ilce = vehicle.ilce || 'Bilinmiyor'; 
                    ilceSayilari[ilce] = (ilceSayilari[ilce] || 0) + 1;
                });

                const labels = Object.keys(ilceSayilari);
                const dataCounts = Object.values(ilceSayilari);
                const ctx = document.getElementById('horizChart').getContext('2d');

                if (window.chart2) { window.chart2.destroy(); }

                window.chart2 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'AraÃ§ SayÄ±sÄ±',
                            data: dataCounts,
                            backgroundColor: '#34495e',
                            borderColor: '#2c3e50',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, title: { display: true, text: 'GerÃ§ek AraÃ§ DaÄŸÄ±lÄ±mÄ±' } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            })
            .catch(err => console.error('AraÃ§ grafiÄŸi hatasÄ±:', err));
        }

        // --- AKSÄ°YON BUTONLARI ---
        function siparisYagdir() { 
            Swal.fire({title:'SipariÅŸler Ä°ÅŸleniyor...', text:'VeritabanÄ± gÃ¼ncelleniyor', timer:1500, showConfirmButton:false}); 
            fetch('/api/talep-arttir', { method: 'POST' })
            .then(res => res.json())
            .then(resp => {
                if(resp.success) setTimeout(veriYukle, 1500);
            });
        }

        function sifirla() { 
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Senaryo baÅŸa dÃ¶necek!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Evet, SÄ±fÄ±rla'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/talep-sifirla', { method: 'POST' })
                    .then(() => {
                        Swal.fire('SÄ±fÄ±rlandÄ±!', '', 'success');
                        veriYukle();
                    });
                }
            });
        }
        
        window.onload = () => { initMap(); veriYukle(); };
    </script>
</body>
</html>